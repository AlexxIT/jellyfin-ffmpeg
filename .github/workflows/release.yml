name: Linux Release

on:
  release: 
    types:
      - released

  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.release }} ${{ matrix.arch }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        release:
          - bullseye
          - buster
          - stretch
          - groovy
          - focal
          - bionic

        arch:
          - amd64
          - arm64
          - armhf

    steps:
      - uses: actions/checkout@v2

      - name: Install make and mmv
        run: sudo apt-get install make mmv

      - name: Install Docker
        uses: docker-practice/actions-setup-docker@v1

      - name: Build
        run: ./build ${{ matrix.release }} ${{ matrix.arch }} dist

      - name: Upload Packages
        uses: actions/upload-artifact@v2.2.3
        with:
          name: ${{ matrix.release }} ${{ matrix.arch }} package
          path: dist

  publish:
    if: always()
    needs: build
    name: Push artifacts to repo
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v2
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R

      - name: Push files to repo
        uses: appleboy/scp-action@v0.1.1
        with:
          host: ${{ secrets.REPO_HOST }}
          username: ${{ secrets.REPO_USER }}
          password: ${{ secrets.REPO_PASSWORD }}
          port: 22
          source: "artifacts/*"
          target: "/srv/repository/incoming/ffmpeg/${{ github.event.release.tag_name }}"
          strip_components: 2
          
      - name: Collect new version
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.REPO_HOST }}
          username: ${{ secrets.REPO_USER }}
          password: ${{ secrets.REPO_PASSWORD }}
          port: 22
          script: /srv/repository/collect-ffmpeg.sh